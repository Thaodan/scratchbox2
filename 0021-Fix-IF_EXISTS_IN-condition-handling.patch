From 0f185fc7fa0ac90fb6d1dd66b5fc6796f77ee890 Mon Sep 17 00:00:00 2001
From: Juha Kallioinen <juha.kallioinen@jollamobile.com>
Date: Thu, 9 May 2013 13:27:31 +0000
Subject: [PATCH] Fix IF_EXISTS_IN condition handling

Signed-off-by: Juha Kallioinen <juha.kallioinen@jollamobile.com>
---
 include/rule_tree.h                    |    1 +
 lua_scripts/add_rules_to_rule_tree.lua |    4 +++-
 pathmapping/paths_ruletree_mapping.c   |   23 +++++++++++------------
 3 files changed, 15 insertions(+), 13 deletions(-)

diff --git a/include/rule_tree.h b/include/rule_tree.h
index 410340c..0dbec3c 100644
--- a/include/rule_tree.h
+++ b/include/rule_tree.h
@@ -207,6 +207,7 @@ typedef struct ruletree_uint32_s {
 #define SB2_RULETREE_FSRULE_CONDITION_IF_REDIRECT_FORCE_IS_ACTIVE 303
 #define SB2_RULETREE_FSRULE_CONDITION_IF_ENV_VAR_IS_NOT_EMPTY 304
 #define SB2_RULETREE_FSRULE_CONDITION_IF_ENV_VAR_IS_EMPTY 305
+#define SB2_RULETREE_FSRULE_CONDITION_IF_EXISTS_IN 306
 
 typedef struct ruletree_net_rule_s {
 	ruletree_object_hdr_t		rtree_net_objhdr;
diff --git a/lua_scripts/add_rules_to_rule_tree.lua b/lua_scripts/add_rules_to_rule_tree.lua
index d1864bc..b22476a 100644
--- a/lua_scripts/add_rules_to_rule_tree.lua
+++ b/lua_scripts/add_rules_to_rule_tree.lua
@@ -33,6 +33,7 @@ local RULE_CONDITION_IF_REDIRECT_IGNORE_IS_ACTIVE = 302
 local RULE_CONDITION_IF_REDIRECT_FORCE_IS_ACTIVE = 303
 local RULE_CONDITION_IF_ENV_VAR_IS_NOT_EMPTY = 304
 local RULE_CONDITION_IF_ENV_VAR_IS_EMPTY = 305
+local RULE_CONDITION_IF_EXISTS_IN = 306
 
 -- and these  must match the flag definitions in mapping.h:
 local RULE_FLAGS_READONLY = 1
@@ -154,7 +155,6 @@ function add_one_rule_to_rule_tree(rule, modename)
 		action_type = RULE_ACTION_SUBTREE
 		rule_list_link = get_rule_tree_offset_for_rule_list(rule.rules, modename)
 	elseif (rule.then_actions) then
-		action_type = RULE_ACTION_CONDITIONAL_ACTIONS
 		rule_list_link = get_rule_tree_offset_for_rule_list(rule.then_actions, modename)
 	end
 
@@ -176,6 +176,8 @@ function add_one_rule_to_rule_tree(rule, modename)
 	elseif (rule.if_env_var_is_empty) then
 		condition_type = RULE_CONDITION_IF_ENV_VAR_IS_EMPTY
 		condition_str = rule.if_env_var_is_empty
+	elseif (rule.if_exists_in) then
+		condition_type = RULE_CONDITION_IF_EXISTS_IN
 	end
 
 	-- Selectors. 
diff --git a/pathmapping/paths_ruletree_mapping.c b/pathmapping/paths_ruletree_mapping.c
index 1f2d170..e833cab 100644
--- a/pathmapping/paths_ruletree_mapping.c
+++ b/pathmapping/paths_ruletree_mapping.c
@@ -661,6 +661,17 @@ static char *ruletree_execute_conditional_actions(
 					}
 					break;
 
+                                case SB2_RULETREE_FSRULE_CONDITION_IF_EXISTS_IN:
+                                  if (if_exists_in(action_cand_p, abs_clean_virtual_path,
+                                                   &mapping_result)) {
+                                    /* found, continue rule tree processing */
+                                    continue;
+                                  }
+                                  else {
+                                    /* not found */
+                                  }
+                                  break;
+
 				default:
 					SB_LOG(SB_LOGLEVEL_ERROR,
 						"ruletree_execute_conditional_actions: "
@@ -686,18 +697,6 @@ static char *ruletree_execute_conditional_actions(
 				}
 				break;
 
-			case SB2_RULETREE_FSRULE_ACTION_IF_EXISTS_IN:
-				if (if_exists_in(action_cand_p, abs_clean_virtual_path,
-                                                 &mapping_result)) {
-                                  /* found, continue rule tree processing */
-                                  continue;
-                                }
-                                else {
-                                  /* not found */
-                                  return(mapping_result);
-				}
-				break;
-
 			case SB2_RULETREE_FSRULE_ACTION_USE_ORIG_PATH:
 			case SB2_RULETREE_FSRULE_ACTION_FORCE_ORIG_PATH:
 			case SB2_RULETREE_FSRULE_ACTION_FORCE_ORIG_PATH_UNLESS_CHROOT:
-- 
1.7.10.3

